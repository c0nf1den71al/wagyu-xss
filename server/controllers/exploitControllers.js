const Finding = require("../models/Finding");
const Host = require("../models/Host");
const { createEvent } = require("../controllers/eventControllers");

module.exports.getQueue = async (hostId) => {
    try {
        const implant = await Host.findById(hostId);
        return implant.queue;
    } catch (err) {
        console.log(err);
    }
}

module.exports.processCompleteCommands = async (hostId, commands) => {
    try {
        const host = await Host.findById(hostId);
        commands.forEach(command => {
            host.queue = host.queue.filter(item => item.id !== command.id);
        });
        await host.save();
    } catch (err) {
        console.log(err);
    }
}

module.exports.processFindings = async (findings, username, hostId) => {
    for (const [key,value] of Object.entries(findings)) {
        try {
            Finding.create({
                name: key,
                createdBy: username,
                hostId: hostId,
                value: value
            })
            
            createEvent("Team Server", `The finding '${key}' was generated by the user '${username}' for the host '${hostId}'.`, "success");

        } catch (err) {
            console.log(err);
        }
    }
}